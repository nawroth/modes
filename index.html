<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>modes.nawroth.se</title>
<link rel="stylesheet"
	href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<script
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script
	src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
<script src="jquery.ba-hashchange.min.js"></script>

<style type="text/css">
#items li {
	list-style-type: none;
	width: 160px;
	height: 80px;
	float: left;
}

#items li.symbol {
	text-align: center;
	font-size: 2em;
	width: 40px;
}

select.equivalent {
	font-weight: bold;
}
</style>
<script type="text/javascript">
  $( function()
  {
    var keysSharp = [ "C", "C♯", "D", "D♯", "E", "F", "F♯", "G", "G♯", "A", "A♯", "B" ], keysFlat = [ "C", "D♭", "D",
        "E♭", "E", "F", "G♭", "G", "A♭", "A", "B♭", "B" ], modes = [ "Ionian", "Dorian", "Phrygian", "Lydian",
        "Mixolydian", "Aeolian", "Locrian" ], modeIntervals = [ 0, 2, 4, 5, 7, 9, 11 ];
    var keys = keysFlat;

    function setOptions(select, collection, transformer)
    {
      var selected = select[0].selectedIndex;
      if ( selected === -1 )
      {
        selected = 0;
      }
      select.empty();
      $( collection ).each( function(index, value)
      {
        if ( typeof ( transformer ) === "function" )
        {
          value = transformer( index, value );
        }
        var option = $( "<option />" ).attr( "value", index ).text( value ).appendTo( select );
      } );
      select.val( selected );
    }

    function setEquivalentOptions(select, keyIndex, modeIndex)
    {
      setOptions( select, modes, function(index, value)
      {
        var interval = modeIntervals[index] - modeIntervals[modeIndex] + keyIndex + 12;
        interval %= 12;
        return value + " " + keys[interval];
      } );
    }

    function createItem(status)
    {
      if ( status.length === 3 )
      {
        createChord( status );
      }
      else
      {
        var parent = $( "#items" );
        var wrapper = $( "<li class='symbol'>" + status + "</li>" );
        wrapper.appendTo( parent );
        var getStatus = function()
        {
          return status;
        };
        wrapper[0]["getStatus"] = getStatus;
      }
    }

    function createChord(status)
    {
      var parent = $( "#items" );
      var wrapper = $( "<li class='item'/>" );
      wrapper.appendTo( parent );
      var key = $( "<select class='key'/>" );
      key.appendTo( wrapper );
      var mode = $( "<select class='mode'/>" );
      mode.appendTo( wrapper );
      setOptions( mode, modes );
      var equivalent = $( "<select class='equivalent'/>" );
      equivalent.appendTo( wrapper );

      var updater = function updateEquivalents()
      {
        setOptions( key, keys );
        setEquivalentOptions( equivalent, $( key )[0].selectedIndex, $( mode )[0].selectedIndex );
      };
      updater();
      key.change( updater );
      mode.change( updater );

      var getStatus = function()
      {
        return Number( $( key )[0].selectedIndex ).toString( 16 ) + $( mode )[0].selectedIndex
            + $( equivalent )[0].selectedIndex;
      }

      var setStatus = function(status)
      {
        $( key ).val( parseInt( status.charAt( 0 ), 16 ) );
        $( mode ).val( status.charAt( 1 ) );
        updater();
        $( equivalent ).val( status.charAt( 2 ) );
      }

      if ( typeof ( status ) === "string" && status.length === 3 )
      {
        setStatus( status );
      }

      wrapper[0]["update"] = updater;
      wrapper[0]["getStatus"] = getStatus;
      wrapper[0]["setStatus"] = setStatus;
    }

    function prepareCpanel(parent)
    {
      $( "#add-scale" ).button().click( function()
      {
        createChord();
      } );

      $( "#add-bar" ).button().click( function()
      {
        createItem( "|" );
      } );

      $( "#add-dash" ).button().click( function()
      {
        createItem( "—" );
      } );

      $( "#sharpflat" ).buttonset().change( function()
      {
        keys = $( "#flat" )[0].checked ? keysFlat : keysSharp;
        $( ".item" ).each( function()
        {
          this.update();
        } );
      } );

      $( "#save" ).button().click( function()
      {
        var status = "";
        $( "#items li" ).each( function()
        {
          status += this.getStatus();
        } );
        var hash = "#" + status;
        var title = $( "#title" ).val();
        if ( title.length > 0 )
        {
          hash += "?" + title;
          window.document.title = title;
        }
        window.history.pushState( status, window.document.title, hash );
      } );
    }

    function initializeState()
    {
      $( "#items" ).empty();
      if ( window.location.hash.length <= 2 )
      {
        return;
      }
      var hash = decodeURIComponent( window.location.hash.substring( 1 ) );
      var pos = hash.indexOf( "?" );
      if ( pos !== -1 )
      {
        window.document.title = hash.substring( pos + 1 );
        $( "#title" ).val( window.document.title );
        hash = hash.substring( 0, pos );
      }
      var states = hash.match( /(\w{1,3}|\W)/g );
      $( states ).each( function()
      {
        createItem( this.toString() );
      } );
    }

    prepareCpanel( $( "#cpanel" ) );
    $( "#items" ).sortable( {
      "revert" : true
    } );

    $( window ).hashchange( function()
    {
      initializeState();
    } );

    $( window ).hashchange();
  } );
</script>

</head>
<body>
	<div id="cpanel">
		<button id="add-scale">Add scale</button>
		<button id="add-bar">Add bar</button>
		<button id="add-dash">Add dash</button>
		<button id="save">Save</button>
		<input type="text" id="title" />
		<div id="sharpflat">
			<input type="radio" value="Flat" id="flat" checked="checked"
				name="sharpflatbutton" /> <label for="flat">♭</label> <input
				type="radio" value="Sharp" id="sharp" name="sharpflatbutton" /> <label
				for="sharp">♯</label>
		</div>
	</div>
	<ol id="items"></ol>
</body>
</html>